#!/bin/bash

CAF_HOME="/users/localadmin/woelke/actor-framework"
BENCH_USER="localadmin"
OUT_DIR="/users/localadmin/woelke/test_data/"
BIN_PATH="/users/localadmin/woelke/caf-measurement/numa/distance/"

cd ${CAF_HOME}/benchmarks/scripts

X_LABEL="mem_access"
BENCH="measure_distance"
B_NODE_A=0
B_CACHE_SIZE=$(lscpu | grep L1d | head -n 1 | awk '{ print $3 }' | sed 's/K/*1024/g' | bc)

x_value_array="100000000 500000000 1000000000 2000000000" #"10 100"
b_rw_rate_array="0 100" #"0 100"
b_node_b_array="0 1 3" #"0 1 3"
b_pattern_array="iterate random" #"iterate random"
for x_value in $x_value_array ; do
  for b_rw_rate in $b_rw_rate_array ; do
  for b_node_b in $b_node_b_array ; do
  for b_pattern in $b_pattern_array ; do
    echo "x_value: $x_value"
    B_NUM_ACCESS=$x_value
    BENCH_ARGS="$b_pattern $B_NODE_A $b_node_b $B_NUM_ACCESS $B_CACHE_SIZE $b_rw_rate"
    label="numa${B_NODE_A}to${b_node_b}rw${b_rw_rate}p${b_pattern}"
    ./caf_run_benchmarks custom $BENCH_USER $OUT_DIR $X_LABEL $x_value $label $BIN_PATH $BENCH $BENCH_ARGS
  done
  done
  done
done

cd $OUT_DIR
${CAF_HOME}/build/bin/to_csv *

cd ${CAF_HOME}/benchmarks/scripts
./plot performance "${OUT_DIR}measure_distance.csv" --out="${OUT_DIR}performance_plot.pdf" --xlabel="Memory Access [#]"
